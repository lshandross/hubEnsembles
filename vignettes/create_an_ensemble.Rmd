---
title: "create_an_ensemble"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{create_an_ensemble}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(hubEnsembles)
library(dplyr)
library(lubridate)
library(here)
library(tibble)
library(vroom)
```
# Runs and formats EuroCOVIDhub ensemble
#  saved in data-processed/EuroCOVIDhub-ensemble

# Setting Up

First we check that 

## Set or get a method

In this vignette we'll form a simple unweighted median ensemble. As the library of ensemble models and methods in `hubEnsembles` grows, this basic method will likely retain the name `median`.

```{r}
method <- "median"
```

Another approach (used now by the EuroCOVIDhub) would be to control this from a hub configuration file:
```{r}
try(method <- get_hub_config("ensemble")[["method"]], silent = TRUE)
print(paste("Method set to", method))
```

## Set current submission date
Next we set the forecast date for the ensemble which determines (in the function `run_ensemble`) the time window for hub submissions that will be used to form the ensemble. This is set to the Monday of the epiweek during which this code is run. (Note that training of more complicated ensemble models involving longer dynamic windows will be handled by other functions.)
```{r}
forecast_date <- today()
wday(forecast_date) <- "Monday"
```

## Get and update model names for manual exclusion
This should involve loading a data frame with a standard list of hub contributors (such as other ensemble models) to be excluded from the ensemble and appending any model names that need to be excluded from the ensemble this week in particular.

exclude_models <-
  vroom(here("code", "ensemble", "EuroCOVIDhub", "manual-exclusions.csv")) %>%
  filter(forecast_date == !!forecast_date) %>%
  pull(model)

# Run weekly ensemble 

```{r}
hub_ensemble <- run_ensemble(
  method = method,
  forecast_date = forecast_date,
  exclude_models = c(exclude_models, "EuroCOVIDhub-baseline"),
  return_criteria = TRUE
)
```

# Save in the hub submission folder
This folder is named `data-processed` in the US and EU COVID hubs and named `data-forecasts` in the FluSight hub.
```{r}

write_csv(hub_ensemble$ensemble,
            here("data-processed",
                 paste0("EuroCOVIDhub-ensemble"),
                 paste0(hub_ensemble$forecast_date,
                        "-EuroCOVIDhub-ensemble.csv")),
            delim = ",")
```


# Record criteria 
<!-- suppressWarnings( -->
<!--   dir.create(here("code", "ensemble", "EuroCOVIDhub", "criteria")) -->
<!-- ) -->
<!-- vroom_write(hub_ensemble$criteria, -->
<!--             here("code", "ensemble", "EuroCOVIDhub", -->
<!--                  "criteria", -->
<!--                  paste0("criteria-", hub_ensemble$forecast_date, ".csv")), -->
<!--             delim = ",") -->

# Record method
This could involve appending to a file named something like `method_by_date.csv`...

